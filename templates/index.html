<!DOCTYPE html>
<html>
  <head>
    <title>File Upload</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Amazon+Ember:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
      body {
        font-family: 'Amazon Ember', sans-serif;
        background-color: #f5f5f5;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }

      .header {
        background-color: #333;
        color: #fff;
        padding: 20px;
        text-align: center;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .header h1 {
        margin: 0;
        font-size: 24px;
      }

      .dark-mode-toggle {
        cursor: pointer;
      }

      .content {
        flex: 1;
        padding: 20px;
        display: flex;
        flex-direction: column;
      }

      .form-group {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
      }

      .form-group input[type="file"] {
        flex-grow: 1;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 3px;
        font-size: 16px;
      }

      .form-group button {
        background-color: #333;
        color: #fff;
        border: none;
        padding: 10px 20px;
        border-radius: 3px;
        font-size: 16px;
        cursor: pointer;
        transition: background-color 0.3s ease;
      }

      .form-group button:hover {
        background-color: #555;
      }

      .loader-container {
        display: none;
        align-items: center;
        margin-left: 10px;
      }

      .loader {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #333;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 2s linear infinite;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      .chat-container {
        flex: 1;
        overflow-y: auto;
        border: 1px solid #ddd;
        padding: 10px;
        display: flex;
        flex-direction: column;
        border-radius: 5px;
        margin-bottom: 20px;
      }

      .interaction {
        margin-bottom: 30px;
        border: 1px solid #ddd;
        padding: 20px;
        border-radius: 5px;
        background-color: #f9f9f9;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .interaction-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 600;
        margin-bottom: 20px;
      }

      .file-name {
        background-color: #333;
        color: #fff;
        padding: 5px 10px;
        border-radius: 3px;
      }

      .item-container {
        margin-bottom: 10px;
        border: 1px solid #ddd;
        padding: 10px;
        border-radius: 5px;
        position: relative;
        background-color: #fff;
      }

      .item-number {
        position: absolute;
        top: -12px;
        left: -12px;
        background-color: #333;
        color: #fff;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        font-weight: bold;
      }

      .no-results {
        font-style: italic;
        color: #888;
      }

      .key {
        font-weight: bold;
        text-transform: uppercase;
      }

      .classification {
        color: #e53935;
      }

      .justification {
        color: #fb8c00;
      }

      .statement {
        color: #43a047;
      }

      .pagination-container {
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: #f5f5f5;
        padding: 10px;
        border-radius: 5px;
      }

      .pagination-container button {
        margin: 0 5px;
        background-color: #333;
        color: #fff;
        border: none;
        padding: 5px 10px;
        border-radius: 3px;
        font-size: 14px;
        cursor: pointer;
        transition: background-color 0.3s ease;
      }

      .pagination-container button:hover {
        background-color: #555;
      }

      .pagination-container button:disabled {
        background-color: #ddd;
        color: #888;
        cursor: not-allowed;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>File Upload</h1>
      <div class="dark-mode-toggle" id="dark-mode-toggle">🌙</div>
    </div>
    <div class="content">
      <form id="upload-form" enctype="multipart/form-data">
        <div class="form-group">
          <input type="file" id="file-input" name="file" required>
          <button type="submit">Upload</button>
          <div class="loader-container">
            <span>Processing file...</span>
            <div class="loader"></div>
          </div>
        </div>
      </form>
      <div class="chat-container" id="response-container"></div>
    </div>
    <div class="pagination-container" id="pagination-container"></div>

    <script>
    const isDarkMode = localStorage.getItem('isDarkMode') === 'true';
      const form = document.getElementById('upload-form');
      const fileInput = document.getElementById('file-input');
      const responseContainer = document.getElementById('response-container');
      const loaderContainer = document.querySelector('.loader-container');
      const MAX_INTERACTIONS_PER_PAGE = 3;
      let currentPage = 0;
      const pages = [];

      // Load interactions from localStorage
      const storedInteractions = JSON.parse(localStorage.getItem('interactions')) || [];
      const interactions = storedInteractions.map(interaction => ({
        ...interaction,
        timestamp: new Date(interaction.timestamp).getTime()
      }));

      form.addEventListener('submit', async (event) => {
        event.preventDefault();
        loaderContainer.style.display = 'flex';

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);

        try {
          const response = await fetch('/process', {
            method: 'POST',
            body: formData
          });

          const data = await response.json();
          const fileName = fileInput.files[0].name;
          const timestamp = new Date().getTime();
          const interaction = { fileName, data, timestamp };
          interactions.push(interaction); // Add new interaction at the end
          updatePages();
          displayInteractions();
          saveInteractionsToLocalStorage();
        } catch (error) {
          console.error('Error:', error);
        } finally {
          loaderContainer.style.display = 'none';
        }
      });

      function displayInteractions() {
        responseContainer.innerHTML = '';

        // Display the current page
        const currentPageInteractions = pages[currentPage];
        for (const interaction of currentPageInteractions) {
          const interactionElement = document.createElement('div');
          interactionElement.classList.add('interaction');

          const headerElement = document.createElement('div');
          headerElement.classList.add('interaction-header');

          const fileNameElement = document.createElement('span');
          fileNameElement.classList.add('file-name');
          fileNameElement.textContent = `File: ${interaction.fileName}`;

          const timeSinceUploadElement = document.createElement('span');
          const timeSinceUpload = getTimeSinceUpload(interaction.timestamp);
          timeSinceUploadElement.textContent = timeSinceUpload;

          headerElement.appendChild(fileNameElement);
          headerElement.appendChild(timeSinceUploadElement);
          interactionElement.appendChild(headerElement);

          if (interaction.data.length === 0) {
            const noResultsElement = document.createElement('div');
            noResultsElement.classList.add('no-results');
            noResultsElement.textContent = 'No statements classified as false in this document.';
            interactionElement.appendChild(noResultsElement);
          } else {
            const itemContainerFragment = document.createDocumentFragment();
            let itemNumber = 1;
            for (const record of interaction.data) {
              const itemContainer = document.createElement('div');
              itemContainer.classList.add('item-container');

              const itemNumberElement = document.createElement('div');
              itemNumberElement.classList.add('item-number');
              itemNumberElement.textContent = itemNumber;
              itemContainer.appendChild(itemNumberElement);

              for (const [key, value] of Object.entries(record)) {
                const row = document.createElement('div');
                const keyCell = document.createElement('span');
                const valueCell = document.createElement('span');
                keyCell.classList.add('key');
                valueCell.textContent = value;

                if (key === 'classification') {
                  keyCell.classList.add('classification');
                  keyCell.textContent = 'Classification: ';
                } else if (key === 'justification') {
                  keyCell.classList.add('justification');
                  keyCell.textContent = 'Justification: ';
                } else if (key === 'statement') {
                  keyCell.classList.add('statement');
                  keyCell.textContent = 'Statement: ';
                }

                row.appendChild(keyCell);
                row.appendChild(valueCell);
                itemContainer.appendChild(row);
              }

              itemContainerFragment.appendChild(itemContainer);
              itemNumber++;
            }
            interactionElement.appendChild(itemContainerFragment);
          }

          responseContainer.appendChild(interactionElement);
        }

        // Add pagination controls
        const paginationContainer = document.getElementById('pagination-container');
        paginationContainer.innerHTML = '';

        const prevButton = document.createElement('button');
        prevButton.textContent = 'Previous';
        prevButton.disabled = currentPage === 0;
        prevButton.addEventListener('click', () => {
          currentPage--;
          displayInteractions();
        });
        paginationContainer.appendChild(prevButton);

        const pageNumbers = document.createElement('div');
        for (let i = 0; i < pages.length; i++) {
          const pageButton = document.createElement('button');
          pageButton.textContent = i + 1;
          pageButton.disabled = i === currentPage;
          pageButton.addEventListener('click', () => {
            currentPage = i;
            displayInteractions();
          });
          pageNumbers.appendChild(pageButton);
        }
        paginationContainer.appendChild(pageNumbers);

        const nextButton = document.createElement('button');
        nextButton.textContent = 'Next';
        nextButton.disabled = currentPage === pages.length - 1;
        nextButton.addEventListener('click', () => {
          currentPage++;
          displayInteractions();
        });
        paginationContainer.appendChild(nextButton);
      }

      function getTimeSinceUpload(timestamp) {
        const now = new Date().getTime();
        const diffInMilliseconds = now - timestamp;
        const diffInMinutes = Math.floor(diffInMilliseconds / (1000 * 60));

        if (diffInMinutes < 1) {
          return 'Just now';
        } else if (diffInMinutes === 1) {
          return '1 minute';
        } else {
          return `${diffInMinutes} minutes`;
        }
      }

      function saveInteractionsToLocalStorage() {
        const serializedInteractions = interactions.map(interaction => ({
          ...interaction,
          timestamp: new Date(interaction.timestamp).toISOString()
        }));
        localStorage.setItem('interactions', JSON.stringify(serializedInteractions));
      }

      function updatePages() {
        // Sort interactions in descending order by timestamp
        interactions.sort((a, b) => b.timestamp - a.timestamp);

        pages.length = 0;
        for (let i = 0; i < interactions.length; i += MAX_INTERACTIONS_PER_PAGE) {
          pages.push(interactions.slice(i, i + MAX_INTERACTIONS_PER_PAGE));
        }
      }

      updatePages();
      displayInteractions();

      const darkModeToggle = document.getElementById('dark-mode-toggle');
      const body = document.querySelector('body');

      if (isDarkMode) {
        body.classList.add('dark-mode');
        darkModeToggle.textContent = '☀️';
      }

      darkModeToggle.addEventListener('click', () => {
        body.classList.toggle('dark-mode');
        darkModeToggle.textContent = body.classList.contains('dark-mode') ? '☀️' : '🌙';
        localStorage.setItem('isDarkMode', body.classList.contains('dark-mode'));
      });
    </script>

    <style>
      .dark-mode {
        background-color: #333;
        color: #fff;
      }

      .dark-mode .header {
        background-color: #222;
      }

      .dark-mode .form-group input[type="file"] {
        background-color: #444;
        color: #fff;
        border-color: #555;
      }

      .dark-mode .form-group button {
        background-color: #555;
      }

      .dark-mode .form-group button:hover {
        background-color: #777;
      }

      .dark-mode .loader {
        border-top-color: #fff;
      }

      .dark-mode .chat-container {
        border-color: #555;
      }

      .dark-mode .interaction {
        background-color: #444;
        border-color: #555;
      }

      .dark-mode .item-container {
        background-color: #555;
        border-color: #666;
      }

      .dark-mode .item-number {
        background-color: #555;
      }

      .dark-mode .no-results {
        color: #aaa;
      }

      .dark-mode .key {
        color: #ccc;
      }

      .dark-mode .classification {
        color: #ff8a80;
      }

      .dark-mode .justification {
        color: #ffcc80;
      }

      .dark-mode .statement {
        color: #a5d6a7;
      }

      .dark-mode .pagination-container {
        background-color: #444;
      }

      .dark-mode .pagination-container button {
        background-color: #555;
      }

      .dark-mode .pagination-container button:hover {
        background-color: #777;
      }

      .dark-mode .pagination-container button:disabled {
        background-color: #666;
        color: #aaa;
      }
    </style>
  </body>
</html>